<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">


        <title>A location-based game to rediscover your city</title>

		<!-- Leafet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
        integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
        crossorigin=""/>

        <!--Leaflet js -->
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
        integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
        crossorigin=""></script>

        <!-- Turf js -->
		<script src='https://unpkg.com/@turf/turf@6.3.0/turf.min.js'></script>

        <!-- Leaflet sidebar  -->
        <link rel="stylesheet"  href="../static/leaflet-sidebar-master/L.Control.Sidebar.css"  /> 
        <script src="../static/leaflet-sidebar-master/L.Control.Sidebar.js"></script> 
        <!-- Leaflet legend  -->
        <link rel="stylesheet"  href="../static/Leaflet.Legend-master/leaflet.legend.css"  /> 
        <script src="../static/Leaflet.Legend-master/leaflet.legend.js"></script> 
		<!-- leaflet search  -->
		<link rel="stylesheet" href="../static/leaflet-search-master/leaflet-search.css" /> 
		<link rel="stylesheet" href="../static/leaflet-search-master/style.css" /> 
        <script src="../static/leaflet-search-master/leaflet-search.js"></script> 
        <!-- leaflet locate-->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
        <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

        <!-- Ajax font-awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

        <!-- Set size to fit mobile browser -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

        <style>

                /* Set the size of web page */
                html, body {
                    padding:0;
                    margin: 0;
                    width: 100%;
                    height: 100%;
                }
                /* Set the size of the map */
                #map {
                    width: 100%;
                    height: 85%;
                }
                /* Set size and style for sidebar menu icon */
                #open_slidebar {
                    background-image: url("../static/pics/menuBlack.png");
                    border: none;
                    height: 33px;
                    width: 35px;
                    margin-top: 37px;
                    margin-right: 15px;
                    position: absolute;
                    top: 0;
                    right: 0;
                    background-color: #ebebf0;
                }

                /* Menu button style */
                button {
                    background: #0084ff;
                    border: none;
                    border-radius: 5px;
                    padding: 8px 14px;
                    font-size: 15px;
                    color: #fff;
                }


        </style>
    </head>


    <!-- Set background colour -->
    <body onload="initMap()", style="background-color: #061529">

        <h1 style= 'font-size: 36px; font-family: Arial; color:white; text-align:center; margin-bottom: -10px; margin-left:10px; text-shadow: 1px 1px whitesmoke'> Manc Stories </h1>

        <!-- A button to switch to the sidebar -->
        <button type= "button" id= "open_slidebar"></button>

        <br>

        <!-- A division to hold the map -->
		<div id='map'></div>

        <!-- Create a sidebar -->
        <div id="sidebar_settings">
            <h1 style="background-color: white ;text-shadow: 1px 1px #061529; padding-right:5px;">Stories discovered:</h1> 				
			<p id="score" style="text-align: center;"></p>
			<hr>
            <h1 style="background-color: white ;text-shadow: 1px 1px #061529; padding-right:5px;">Distance walked (km):</h1> 				
			<p id="dist_tracker" style="text-align: center;"></p>
            <hr>
            <h1 style="background-color: white ;text-shadow: 1px 1px #061529; padding-right:5px;"> Add your own story here: <a href="https://outaos.pythonanywhere.com/" target="_blank">Create!</a></h1>
			<hr>
            <!-- "Personal Stories" rules -->
			<h1 style="background-color: white ;text-shadow: 1px 1px #061529; padding-right:5px;"> Gameflow </h1>
			<p> 1. Walk around central Manchester to discover stories. <br> 2. Touch the 'feet' icon to see how far you are from the nearest story. <br> 3. Once you enter an invisible geofence the hint will popup and the geofence will appear on the map. <br> 4. Walk inside the geofence and the story will appear on the map. <br> 5. Dare to add you own stories <a href="https://outaos.pythonanywhere.com/">here</a>. <br> 6. Share this web app with friends!</p>
			<hr>
            <h1 style="background-color: white ;text-shadow: 1px 1px #061529; padding-right:5px;"> Further information</h1>
            <p>
                This mode allows you to discover stories recorded by the author of this app (<a href="https://www.instagram.com/ozz_outao/" target="_blank">link for criticism</a>) and his awesome friends.
                Some of these stories happened in Manchester and some in other distant corners of the world.
                However, all thess stories are location-based, and who knows, maybe some of them are about you!
            </p>
            <hr>
            <h1 style="background-color: white ;text-shadow: 1px 1px #061529; padding-right:5px;"> Return to <a href="https://outaos.pythonanywhere.com/play" target="_blank">Play</a></h1>


		</div>




        <script>

            // global variable for map
            let map;
            // Set location variable to 'null' to account for no info when user just enters the game
            let position = null;

            // Counter for score
			let geofence_tracker = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];

            // initialise empty array for updated coords
            let locationList = []

            // A function to set the flag variable to 'false' for every buffer in enterBuffer_b
            let enterBuffer_b
            let flag_b
            let flag_a

            // Variable for arrays of buffers
            let dots, outofBufferB, b_buffers, a_buffers;

            // variables for the arrays of popups
            let b_popups, popup_audio

            // Variable for the square grid
            let cover;

            let geoLine;



            // Style inner and outer geofences. Make them invisible
            const midStyle = {
                "color": "#2E86C1",
                "weight": 0,
                "fillOpacity": 0.0
            };

            const innerStyle = {
                "color": "#2E86C1",
                "weight": 0,
                "fillOpacity":0.0
            };

            // Style the entered geofences
            const enterstyleIn = {
                "color": "#0E6655",    // green
                "weight": 3,
                "fillOpacity": 0.3
            };

            const enterstyleMid = {
                "color": "#2E86C1",   // blue
                "weight": 3,
                "fillOpacity": 0.3
            };


        /**
         * Initialise the map (called when the body has loaded)
         */
        function initMap(){

            // Coordinate information for the location of stories hidden in Manchester
            var data = [
							{"loc":[53.474824,-2.238472], "title":"story 1 (Hotel)"},
							{"loc":[53.475476,-2.234458], "title":"story 2 (Frog)"},
							{"loc":[53.478758,-2.239871], "title":"story 3 (Dragon)"},
							{"loc":[53.476903,-2.236298], "title":"story 4 (Rachel)"},
							{"loc":[53.480616,-2.229870], "title":"story 5 (Shy friend)"}
						];

            // Map tiles
            map = L.map('map');
            const mapCentre = L.latLng(53.4808,-2.2426);
            map.setView(mapCentre,16); 
            // Simple map tiles without irrelevant information
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                        subdomains: 'abcd',
                        maxZoom: 20
                    }).addTo(map);


            // Add a scale to the map
            L.control.scale().addTo(map);

            // Create locate control and add to map
                lc = L.control.locate({
                    position: 'topleft',
                    locateOptions: {
                        enableHighAccuracy: true
                    },
                    strings: {
                        title: "Show me where I am!"
                    }
                }).addTo(map);

            // A function for specific search of the locations of stories
            function localData(text, callResponse)
                {
                callResponse(data);
                return {	//called to stop previous requests on map move
                    abort: function() {
                        console.log('aborted request:'+ text);
                    }
                };
                }
                map.addControl( new L.Control.Search({sourceData: localData, text:'Name...', markerLocation:true}) );




            // Sidebar
            var sidebar_settings = L.control.sidebar('sidebar_settings', {
                position: 'right'
            });
            map.addControl(sidebar_settings);
            document.getElementById("open_slidebar").onclick = Toggle;
            function Toggle () {
                sidebar_settings.toggle();
            };


            // GeoJSON streets layer. Shows where stories might be hidden.
            const stories = {
            "type": "FeatureCollection",
            "features": [
                {
                "type": "Feature",
                "properties": {
                    "stroke": "#909497",
                    "stroke-width": 2,
                    "stroke-opacity": 0.2
                },
                "geometry": {
                    "type": "LineString",
                    "coordinates": [
                    [
                        -2.2386467456817623,
                        53.474899758735255
                    ],
                    [
                        -2.238367795944214,
                        53.47474650564816
                    ],
                    [
                        -2.237766981124878,
                        53.474969999548556
                    ],
                    [
                        -2.2376704216003414,
                        53.474855059975354
                    ],
                    [
                        -2.235342264175415,
                        53.4753914419867
                    ],
                    [
                        -2.233099937438965,
                        53.475946973351036
                    ],
                    [
                        -2.2337865829467773,
                        53.47668767052368
                    ],
                    [
                        -2.2344839572906494,
                        53.47658550616509
                    ],
                    [
                        -2.2359859943389893,
                        53.47618961695227
                    ],
                    [
                        -2.2379493713378906,
                        53.47564685960914
                    ],
                    [
                        -2.2412216663360596,
                        53.47465072218766
                    ],
                    [
                        -2.2416508197784424,
                        53.47518710678182
                    ],
                    [
                        -2.240492105484009,
                        53.47557661991623
                    ],
                    [
                        -2.238560914993286,
                        53.47614491955103
                    ],
                    [
                        -2.2370588779449463,
                        53.47691753943111
                    ],
                    [
                        -2.235889434814453,
                        53.47627901161351
                    ],
                    [
                        -2.2350096702575684,
                        53.47492530086263
                    ],
                    [
                        -2.2375094890594482,
                        53.47444638341602
                    ],
                    [
                        -2.2380459308624268,
                        53.47574902622766
                    ],
                    [
                        -2.2386360168457027,
                        53.47619600229145
                    ],
                    [
                        -2.240599393844604,
                        53.477824232422805
                    ],
                    [
                        -2.2399020195007324,
                        53.478322266808014
                    ],
                    [
                        -2.2402560710906982,
                        53.47849466196399
                    ],
                    [
                        -2.2394943237304688,
                        53.479062922518295
                    ]
                    ]
                }
                }
            ]
            };

            // GeoJSON style
            const myStyle = {
                "color": "#7B7D7D",
                "weight": 8,
                "opacity": 0.4
            };

            L.geoJSON(stories, {style: myStyle}).addTo(map);



            /*
            // TRACK PLAYER'S LOCATION  *************************************************************************************************
            */
            // Leaflet function that tracks player's geolocation
            map.locate({setView: false, maxZoom: 16, watch: true, enableHighAccuracy: true});   


            /*/////////////////////////////////////////////////////////
            //INFO ON BUFFERS AND POPUPS
            *//////////////////////////////////////////////////////////
            //Icon class for custom icons
            let manIcon = L.Icon.extend({
                options: {
                    iconSize: [1,1],
                    iconAnchor: [23,37],
                    popupAnchor: [-5, -37]
                }
            });
            const dot = new manIcon({iconUrl: '../static/pics/dot.png'});



            /*
            // STORIES  *************************************************************************************************
            */
            // Story # 1 Kempinski
            // Create a turf point for the location of the story
            const dot_1  = turf.point([-2.238472,53.474824]);      
            // Use the turf point as a centre for inner and outer buffers                                     
            const a_buff_1 = turf.buffer(dot_1, 0.03, {units:'kilometers',steps:24});              
            const b_buff_1 = turf.buffer(dot_1, 0.06, {units:'kilometers', steps:24});

            // Style and add inner buffer to the map
            L.geoJSON(a_buff_1,{style: innerStyle}).addTo(map);
            // Style and add outer buffer to the map
            L.geoJSON(b_buff_1, {style: midStyle}).addTo(map);

            // Create a marker for the popup
            const story_1 = L.marker([53.474824,-2.238472], {icon:dot}).bindPopup().addTo(map);

            // Buffer 'b' popups (Outer geofence)
            const b_pop_1_info = ("<h1 style ='text-align:center; color: #263985'> You are very close to a story about the Great Wall hotel!</h1><b> Walk to the end of Granby Row an ugly car park and a beautiful Kimpton hotel.</b> <br> <b> Please take a screenshot of the picture below, it will be handy! </b> <iframe src='../static/pics/hotel.jpg' width='300' height='300' frameborder='0' ></iframe>")   //Add content using HTML tags  width='300' height='300'
            const b_pop_1 = story_1.bindPopup(b_pop_1_info, {
                maxWidth: 320,
                maxHeight: 400
            });
            story_1.off('click');

            // POPUP 1 (Inner geofence)
            const audioIcon1 = L.icon({
                iconUrl: "../static/pinkMusic.png",       
                iconSize: [30, 30], // size of the icon  
                iconAnchor: [12, 41], // marker icon position  
                popupAnchor: [0, -60], // popup position
            });
            // Inner buffer popup content
            const a_pop_1_info =
            "<h3>You are a legend!</h3><br><b>Here is a story for you:</b><br><iframe src='../static/media/Kempinski_2.mp3' width='300' height='300' frameborder='0' ></iframe>";
            // Specify popup options
            const a_customOptions1 = {
            maxWidth: "auto", // set max-width
            className: "customPopup", // name custom popup
            };
            const a_pop_1 = L.marker([53.474824,-2.238472], {icon: audioIcon1}).bindPopup(a_pop_1_info, a_customOptions1);



            // Story # 2  Frog
            const dot_2  = turf.point([-2.234458,53.475476]);                       
            const a_buff_2 = turf.buffer(dot_2, 0.03, {units:'kilometers',steps:24});
            const b_buff_2 = turf.buffer(dot_2, 0.06, {units:'kilometers', steps:24});

            var story_2 = L.marker([53.475476,-2.234458], {icon:dot}).bindPopup().addTo(map);

            L.geoJSON(a_buff_2,{style: innerStyle}).addTo(map);
            L.geoJSON(b_buff_2, {style: midStyle}).addTo(map);

            // Buffer 'b' popups
            const b_pop_2_info = ("<h1 style ='text-align:center; color: #263985'> You are very close to a story about a frog with the beautiful legs!</h1><b> The frog is hinding behind the ugliest and biggest monument to Vimto in the world.</b> <br> <b>  Please take a screenshot of the picture below, it will be handy! </b> <iframe src='../static/pics/frog2.jpg' width='300' height='300' frameborder='0' ></iframe>")   //<iframe src='pics/02_oak_street_rs.jpg' width='300' height='300' frameborder='0' ></iframe>
            const b_pop_2 = story_2.bindPopup(b_pop_2_info, {
                maxWidth: 320,
                maxHeight: 400
            });
            story_2.off('click');

            // POPUP 2
            const audioIcon2 = L.icon({
                iconUrl: "../static/pinkMusic.png",      
                iconSize: [30, 30], // size of the icon  
                iconAnchor: [12, 41], // changed marker icon position  
                popupAnchor: [0, -60], // changed popup position
            });
            const a_pop_2_info =
            "<h3>You are a legend!</h3><br><b>Here is a story for you:</b><br><iframe src='../static/media/Frog_2.mp3' width='300' height='300' frameborder='0' ></iframe>";
            // specify popup options
            const a_customOptions2 = {
            maxWidth: "auto", // set max-width
            className: "customPopup", // name custom popup
            };
            const a_pop_2 = L.marker([53.475476,-2.234458], {icon: audioIcon2}).bindPopup(a_pop_2_info, a_customOptions2);


            // Story # 3  Dragon
            const dot_3  = turf.point([-2.239871,53.478758]);                           
            const a_buff_3 = turf.buffer(dot_3, 0.03, {units:'kilometers',steps:24});                      
            const b_buff_3 = turf.buffer(dot_3, 0.06, {units:'kilometers', steps:24});

            var story_3 = L.marker([53.478758,-2.239871], {icon:dot}).bindPopup().addTo(map);   

            L.geoJSON(a_buff_3,{style: innerStyle}).addTo(map);
            L.geoJSON(b_buff_3, {style: midStyle}).addTo(map);


            // Buffer 'b' popups
            const b_pop_3_info = ("<h1 style ='text-align:center; color: #263985'> You are very close to a story about the Chinese dragon!</h1><b> Walk to St. James street, on the other side of the car park</b><br> <b> Please take a screenshot of the picture below, it will be handy! </b><iframe src='../static/pics/dragon.jpg' width='300' height='300' frameborder='0' ></iframe>")   //<iframe src='pics/02_oak_street_rs.jpg' width='300' height='300' frameborder='0' ></iframe>
            const b_pop_3 = story_3.bindPopup(b_pop_3_info, {
                maxWidth: 320,
                maxHeight: 400
            });
            story_3.off('click');

            // POPUP 3
            const audioIcon3 = L.icon({
                iconUrl: "../static/pinkMusic.png",       
                iconSize: [30, 30], // size of the icon  
                iconAnchor: [12, 41], // changed marker icon position  
                popupAnchor: [0, -60], // changed popup position
            });
            const a_pop_3_info =
            "<h3>You are a legend!</h3><br><b>Here is a story for you:</b><br><iframe src='../static/media/Dragon_2.mp3' width='300' height='300' frameborder='0' ></iframe>";
            // specify popup options
            const a_customOptions3 = {
            maxWidth: "auto", // set max-width
            className: "customPopup", // name custom popup
            };
            const a_pop_3 = L.marker([53.478758,-2.239871], {icon: audioIcon3}).bindPopup(a_pop_3_info, a_customOptions3);




            // FAKE INVADERS FOR TESTING

            // Story # 101  Rachel                                                                
            const dot_101  = turf.point([-2.236298,53.476903]);
            const a_buff_101 = turf.buffer(dot_101, 0.03, {units:'kilometers',steps:24});
            const b_buff_101 = turf.buffer(dot_101, 0.06, {units:'kilometers', steps:24});

            var story_101 = L.marker([53.476903,-2.236298], {icon:dot}).bindPopup().addTo(map);

            L.geoJSON(a_buff_101,{style: innerStyle}).addTo(map);
            L.geoJSON(b_buff_101, {style: midStyle}).addTo(map);

            // Buffer 'b' popups
            const b_pop_101_info = ("<h1 style ='text-align:center; color: #263985'> You are very close to a story about Rachel (the name is fake, but story's real)!</h1><b> The story is hidden in Sackville Garden park.</b> <br> <b> Please take a screenshot of the picture below, it will be handy! </b><iframe src='../static/pics/hippie.jpg' width='300' height='300' frameborder='0' ></iframe>")
            const b_pop_101 = story_101.bindPopup(b_pop_101_info, {
                maxWidth: 320,
                maxHeight: 400
            });
            story_101.off('click');

            // POPUP 101
            const audioIcon101 = L.icon({
                iconUrl: "../static/pinkMusic.png",       
                iconSize: [30, 30], // size of the icon  
                iconAnchor: [12, 41], // changed marker icon position  
                popupAnchor: [0, -60], // changed popup position
            });
            const a_pop_101_info =
            "<h3>You are a legend!</h3><br><b>Here is a story for you:</b><br><iframe src='../static/media/Natalie_2.mp3' width='300' height='300' frameborder='0' ></iframe>";
            // specify popup options
            const a_customOptions101 = {
            maxWidth: "auto", // set max-width
            className: "customPopup", // name custom popup
            };
            const a_pop_101 = L.marker([53.476903,-2.236298], {icon: audioIcon101}).bindPopup(a_pop_101_info, a_customOptions101);



            // Story # 102                                                               
            const dot_102  = turf.point([-2.229870,53.480616]);
            const a_buff_102 = turf.buffer(dot_102, 0.03, {units:'kilometers',steps:24});
            const b_buff_102 = turf.buffer(dot_102, 0.06, {units:'kilometers', steps:24});

            var story_102 = L.marker([53.480616,-2.229870], {icon:dot}).bindPopup().addTo(map);

            L.geoJSON(a_buff_102,{style: innerStyle}).addTo(map);
            L.geoJSON(b_buff_102, {style: midStyle}).addTo(map);

            // Buffer 'b' popups
            const b_pop_102_info = ("<h1 style ='text-align:center; color: #263985'> You are very close a story about a shy guy.</h1><b> Walk towards the cananl, the story is hidden behind Dakota hotel. </b><br> <b> Please take a screenshot of the picture below, it will be handy! </b><iframe src='../static/pics/shy.jpg' width='300' height='300' frameborder='0' ></iframe>")
            const b_pop_102 = story_102.bindPopup(b_pop_102_info, {
                maxWidth: 320,
                maxHeight: 400
            });
            story_102.off('click');

            // POPUP 102
            const audioIcon102 = L.icon({
                iconUrl: "../static/pinkMusic.png",       
                iconSize: [30, 30], // size of the icon   
                iconAnchor: [12, 41], // changed marker icon position  
                popupAnchor: [0, -60], // changed popup position
            });
            const a_pop_102_info =
            "<h3>You are a legend!</h3><br><b>Here is a story for you:</b><br><iframe src='../static/media/Shy_guy_2.mp3' width='300' height='300' frameborder='0' ></iframe>";
            // specify popup options
            const a_customOptions102 = {
            maxWidth: "auto", // set max-width
            className: "customPopup", // name custom popup
            };
            const a_pop_102 = L.marker([53.480616,-2.229870], {icon: audioIcon102}).bindPopup(a_pop_102_info, a_customOptions102);





            // Story # 103        ALB South    [53.466621,-2.236100]                                                             
            const dot_103  = turf.point([-2.226024,53.493367]);
            const a_buff_103 = turf.buffer(dot_103, 0.03, {units:'kilometers',steps:24});
            const b_buff_103 = turf.buffer(dot_103, 0.06, {units:'kilometers', steps:24});

            var story_103 = L.marker([53.493367,-2.226024], {icon:dot}).bindPopup().addTo(map);

            L.geoJSON(a_buff_103,{style: innerStyle}).addTo(map);
            L.geoJSON(b_buff_103, {style: midStyle}).addTo(map);

            // Buffer 'b' popups
            const b_pop_103_info = ("<h1 style ='text-align:center; color: #263985'> You are very close a story about a shy guy.</h1><b> Walk towards the cananl, behind Dakota hotel. </b><br> <b> Please take a screenshot of the picture below, it will be handy! </b><iframe src='../static/pics/shy.jpg' width='300' height='300' frameborder='0' ></iframe>")
            const b_pop_103 = story_103.bindPopup(b_pop_103_info, {
                maxWidth: 320,
                maxHeight: 400
            });
            story_103.off('click');

            // POPUP 103
            const audioIcon103 = L.icon({
                iconUrl: "../static/pinkMusic.png",       
                iconSize: [30, 30], // size of the icon   
                iconAnchor: [12, 41], // changed marker icon position 
                popupAnchor: [0, -60], // changed popup position
            });
            const a_pop_103_info =
            "<h3>You are a legend!</h3><br><b>Here is a story for you:</b><br><iframe src='../static/media/Shy_guy_2.mp3' width='300' height='300' frameborder='0' ></iframe>";
            // specify popup options
            const a_customOptions103 = {
            maxWidth: "auto", // set max-width
            className: "customPopup", // name custom popup
            };
            const a_pop_103 = L.marker([53.493367,-2.226024], {icon: audioIcon103}).bindPopup(a_pop_103_info, a_customOptions103);


            /*
            // Geofences   ///////////////
            */

            // Areas outside of the largest buffers
            outofBufferB = [b_buff_1, b_buff_2, b_buff_3, b_buff_101,b_buff_102,b_buff_103];
            // Points in the centre of each buffer
            dots = turf.featureCollection([dot_1, dot_2, dot_3, dot_101,dot_102,dot_103]);

            // OUTER buffers list (larger buffers)
            b_buffers = [b_buff_1, b_buff_2, b_buff_3, b_buff_101,b_buff_102, b_buff_103];
            // OUTER buffers' popups
            b_popups = [b_pop_1, b_pop_2, b_pop_3, b_pop_101,b_pop_102, b_pop_103];

            // INNER buffers list (smaller buffers)
            a_buffers = [a_buff_1,a_buff_2, a_buff_3, a_buff_101,a_buff_102, a_buff_103];
            // Audio popups
            popup_audio = [a_pop_1, a_pop_2, a_pop_3, a_pop_101, a_pop_102, a_pop_103];


            // SQUARE GRID
            // Specify units for measurement
            let gridOptions = {units: 'kilometers'};
            // Get grid as a turf polygon
            let grid = turf.squareGrid([-2.242425,53.472759,-2.227574,53.481928], 0.1, gridOptions);   
            // Turn grid into geoJson to display on a map
            cover = L.geoJson(grid, {style: {color:'#000000', fill: '#89CFF0', fillOpacity: 0.6, weight: 0.0}}).addTo(map);


            // A function to set the flag variable to 'false' for every buffer in enterBuffer_b
            enterBuffer_b = [];
                for (let i=0; i<b_buffers.length; i++){
                    enterBuffer_b.push(false);}

            flag_b = [];
                for (let i=0; i<b_buffers.length; i++){
                    flag_b.push(false);}

            flag_a = [];
                for (let i=0; i<a_buffers.length; i++){
                    flag_a.push(false);}



            // Location error function
            function onLocationError(e) {
                alert(e.message);
            }
            map.on('locationerror', onLocationError);

            // bind listeners
            map.on('locationfound', onLocationFound);
            map.on('locationerror', onLocationError);

            ////////////////////////////////
            // LEGEND WITH ALL HIDDEN STORIES
            ////////////////////////////////
            L.control.Legend({
                    position: "bottomright",
                    collapsed: true,
                    legends: [{
                        label : "story 1 (Hotel)",
                        type: "image",
                        url: "../static/pics/skyscraper.png",
                        attribution: '<a href="https://www.flaticon.com/free-icons/skyscraper" title="skyscraper icons">Skyscraper icons created by Freepik - Flaticon</a>',
                    },{
                        label: "story 2 (Frog)",
                        type: "image",
                        url: "../static/pics/frog.png",
                        attribution: '<a href="https://www.flaticon.com/free-icons/frog" title="frog icons">Frog icons created by Freepik - Flaticon</a>',
                    },{
                        label: "story 3 (Dragon)",
                        type: "image",
                        url: "../static/pics/dragon.png",
                        attribution: '<a href="https://www.flaticon.com/free-icons/dragon" title="dragon icons">Dragon icons created by Freepik - Flaticon</a>',
                    },{
                        label: "story 4 (Rachel)",
                        type: "image",
                        url: "../static/pics/couple.png",
                        attribution: '<a href="https://www.flaticon.com/free-icons/couple" title="couple icons">Couple icons created by Freepik - Flaticon</a>',
                    },{
                        label: "story 5 (A shy guy)",
                        type: "image",
                        url: "../static/pics/mashy.png",
                        attribution: '<a href="https://www.flaticon.com/free-icons/shy" title="shy icons">Shy icons created by Freepik - Flaticon</a>',
                    },]
                }).addTo(map);
                //////////////////////////////////////////////////////////////////////////////////////////////////////
        };


            /*
            // GEOLOCATION FUNCTION   *************************************************************************************************
            */
            function onLocationFound(e) {

                /*
                // Player's location   ///////////////
                */

                // Create a turf point to be able to interact with the other features
                player = turf.point([e.latlng.lng, e.latlng.lat]);
                // Geolocation icon
                const playerIcon = L.icon({
                    iconUrl: '../static/feet.png',
                    iconSize: [37,37],
                    iconAnchor: [17, 37],
                    popupAnchor: [0,-37],
                })
                // Print the coords to the console.
                console.log("Your current position is at:" +e.latlng);
                // This accounts for the geolocation when the user just opens the game
                if (position == null) {
                    position = L.marker(e.latlng, {icon:playerIcon}).addTo(map);
                // Update the geolocation when the current location is known
                } else {
                    position.setLatLng(e.latlng);
                }

                // Push the person's location to the array
                locationList.push([e.latlng.lng, e.latlng.lat]); 
                console.log(locationList);

                // Create a lineString
                let myLine = turf.lineString(locationList, {name:"user track"}); 
                // let myLineJson = L.geoJson(myLine);
                // Simplify the line using a turf function
                const options = {tolerance: 0.000001, highQuality: false}; 
                let simplified = turf.simplify(myLine, options);

                // calculate the length of the user track
                playerPath = turf.lineDistance(simplified, 'kilometers');   
                // Round the number
                let rounded = playerPath.toFixed(3);
                console.log(playerPath);
                document.getElementById("dist_tracker").innerHTML = rounded;



                // Remove the privious layer every time the location updates
                if (geoLine) {
                    geoLine.remove();
                    };
                // add a Json line to the map
                geoLine = L.geoJson(simplified, {style: {      
                                                weight: 2,
                                                color: '#1A5276',
                                                fillOpacity: 1,
                                                fillColor: 'lightgrey',
                                            }}).addTo(map);


                // calculate the nearest point
                var nearest = turf.nearestPoint(player, dots);

                // For loop to assess if current location is outside the buffers and if yes add a popup notifying the user about the time to the target
                for ( let i=0; i<outofBufferB.length; i++) {
                    inside = turf.booleanWithin(player, outofBufferB[i],)
                    if (inside === false) {
                        let distance = Math.round(turf.distance(player,nearest,{units:'kilometers'})*1000)/1000;  
                        // 5 km/hr is an average speed of a person
                        let time_dist =  Math.round(60*distance)/5;
						position.bindPopup("<h1 style ='text-align:center; color: #061529'>Yes! There are some stories in here!</h1> <b>The nearest story is about: " + time_dist.toString()+" minutes away!</b>", {maxWidth: 200});
                        }
                    else {
                        position.bindPopup("<strong>You very close.</strong><br />Keep exploring!.<br> <b> Walking towards the centre of the circle would help. </b>", {maxWidth: 500});
                    }
                };



                // BUFFER B
                for (let i=0; i<b_buffers.length; i++){

                    // TESTING: add to the map (and remove previous one to avoid accumulation)
                    geoJSON = L.geoJSON(b_buffers[i]).addTo(map);
                    if (geoJSON) map.removeLayer(geoJSON);

                    // Check whether a player is within the geofence 
                    const currentlyWithin_b = turf.booleanWithin(player, b_buffers[i]);

                    // If player was NOT within the buffer at the last location
                    if (!flag_b[i]) {

                        // Enter the geofence
                        if (currentlyWithin_b){

                            // Open a popup for outer buffers
                            b_popups[i].openPopup();
                            // Create marker object
                            L.geoJSON(b_buffers[i], {style: enterstyleMid}).addTo(map);

                            // Update the flag
                            flag_b[i] = true;

                        };

                    // If player WAS within the buffer at the last location
                    } else {

                        // Update the flag
                        flag_b[i] = currentlyWithin_b;
                    }

                };


                // BUFFER A
                for (let i=0; i<a_buffers.length; i++){

                    // TESTING: add to the map (and remove previous one to avoid accumulation)
                    geoJSON = L.geoJSON(a_buffers[i]).addTo(map);
                    if (geoJSON) map.removeLayer(geoJSON);

                    // Check whether a player is within the geofence 
                    const currentlyWithin_a = turf.booleanWithin(player, a_buffers[i]);

                    // If player was NOT within the buffer at the last location
                    if (!flag_a[i]) {

                        // Enter the geofence
                        if (currentlyWithin_a){
                            // Create marker object
                            L.geoJSON(a_buffers[i], {style: enterstyleIn}).addTo(map);
                            // update the flag
                            flag_a[i] = true;

                        };

                    // If player WAS within the buffer at the last location
                    } else {

                        // Update the flag
                        flag_a[i] = currentlyWithin_a;
                    }

                };

                // For loop for Inner Buffer audio Popups
                for ( let i = 0; i < a_buffers.length; i++) {
                    if (turf.booleanWithin(player, a_buffers[i])) {
                        popup_audio[i].addTo(map);   // .openPopup()
                        if (geofence_tracker [i] == 0) {
                            geofence_tracker[i] =1;
                            points = 0;
                            for(let j in geofence_tracker) {points += geofence_tracker[j]};
                            document.getElementById("score").innerHTML = points;
                            };
						};
                    };



                /*/////////////////////////////////////////////////////////////////////////////////////////////////////
                // SQUARE GRID
                */////////////////////////////////////////////////////////////////////////////////////////////////////


                // Loop through each grid square
                cover.eachLayer(function(layer){

                    // Get grid as a turf polygon
                    let poly = turf.polygon(layer.feature.geometry.coordinates);
                    // Check if avatar intersects with grid
                    let ptIntersect = turf.booleanPointInPolygon(player, poly);
                    // Get bounds of the grid and zoom to it
                    if(ptIntersect === true){
                        // Update the layer to ensure that only squares where the player is located are see-through
                        layer.setStyle({fillOpacity: 0})
                    }
                });

            };

        </script>
    </body>

</html>

